<link rel="import" href="smart-building-component.html">
<link rel="import" href="smart-building-style.html">
<link rel="import" href="smart-building-section.html">
<link rel="import" href="smart-building-smart.html">
<link rel="import" href="/static/src/or-checkbox/or-checkbox.html">

<dom-module id="smart-building-security">
    <template>
        <style include="smart-building-style">

            .alarm {
                margin: 10px 0;
            }

            .residencePresenceStatus {
                padding: 10px 20px;
            }

            .roomLabel {
                padding: 0 10px;
            }

            .presenceStatus {
                color: var(--theme-mediumgrey);
            }

            .roomPresenceStatusItem {
                margin: 10px 0;
            }

        </style>

        <smart-building-smart residence="[[residence]]"></smart-building-smart>

        <smart-building-section>

            <div class="layout horizontal center alarm">
                <template is="dom-if" if="[[residence.attributes.presenceDetected.value]]">
                    <img height="80" src="smart-building/img/eye_large_active.png"/>
                </template>
                <template is="dom-if" if="[[!residence.attributes.presenceDetected.value]]">
                    <img height="80" src="smart-building/img/eye_large.png"/>
                </template>
                <div class="flex layout vertical residencePresenceStatus">
                    <div>[[localize('Alarm')]]</div>
                    <div class="presenceStatus">
                        [[computePresenceStatus(residence.attributes.presenceDetected.value)]]
                    </div>
                </div>
                <div class="layout horizontal">
                    <or-checkbox checked="[[residence.attributes.alarmEnabled.value]]"
                                 on-change="onAlarmEnabledChange"></or-checkbox>
                </div>
            </div>

            <div class="layout vertical">
                <template is="dom-repeat" items="[[roomsPresenceStatus]]">
                    <div class="layout horizontal center roomPresenceStatusItem">
                        <div class="layout vertical center-center">
                            <img height="30" src="smart-building/img/eye.png"/>
                        </div>
                        <div class="flex layout horizontal roomLabel">
                            [[localize(item.roomName)]]
                        </div>
                        <div class="presenceStatus">
                            [[computePresenceStatus(item.presenceDetected)]]
                        </div>
                    </div>
                </template>
            </div>

        </smart-building-section>

    </template>

    <script>
        class SmartBuildingSecurity extends SmartBuildingComponent {
            static get is() {
                return "smart-building-security";
            }

            static get properties() {
                return {
                    roomsPresenceStatus: {
                        type: Array,
                        computed: "computeRoomsPresenceStatus(rooms.*)"
                    }
                }
            }

            onAlarmEnabledChange(e) {
                this.sendAttributeEvent(
                    this.residence.id, "alarmEnabled", e.detail
                );
            }

            computePresenceStatus(presenceDetected) {
                return presenceDetected === true ? this.localize("Presence detected") : this.localize("No presence");
            }

            computeRoomsPresenceStatus(rooms) {
                let roomsPresenceStatus = [];
                if (!this.rooms)
                    return roomsPresenceStatus;
                this.rooms.forEach(room => {
                    if ("presenceDetected" in room.attributes) {
                        roomsPresenceStatus.push({
                            roomId: room.id,
                            roomName: room.name,
                            presenceDetected: room.attributes.presenceDetected.value
                        });
                    }
                })
                return roomsPresenceStatus;
            }
        }

        defineAppElement(SmartBuildingSecurity, SmartBuildingSecurity.is, "SmartBuildingSecurity");
    </script>

</dom-module>
