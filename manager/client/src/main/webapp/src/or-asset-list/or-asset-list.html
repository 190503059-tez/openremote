<link rel="import" href="or-asset-list-item.html">

<dom-module id="or-asset-list">

    <template>
        <style include="or-style">
        </style>

        <slot id="slot"></slot>
    </template>

    <script>
        class OpenRemoteAssetList extends OpenRemoteViewComponent {

            static get is() {
                return "or-asset-list";
            }

            static get properties() {
                return {

                    selectInclude: {
                        type: String,
                        value: () => {
                            return "ALL_EXCEPT_PATH_AND_ATTRIBUTES"
                        }
                    },

                    assetType: {
                        type: String
                    },

                    assets: {
                        type: Array,
                        observer: "onAssetsChange"
                    }
                }
            }

            static get observers() {
                return [
                    "executeQuery(selectInclude, assetType)"
                ];
            }

            constructor() {
                super();
            }

            connectedCallback() {
                super.connectedCallback();

                this.showComponent();
            }

            executeQuery(selectInclude, assetType) {
                openremote.REQUEST.sendAndReturn(
                    (requestParams) => {
                        let query = {
                            select: {
                                include: selectInclude
                            },
                        }

                        if (assetType) {
                            query.type = {predicateType: "string", value: assetType}
                        }

                        openremote.REST.AssetResource.queryAssets(requestParams, query);
                    },
                    200,
                    (response) => {
                        this.set("assets", response);
                    },
                    (exception) => {
                        // TODO Exception handler
                        console.log("### GOT EXCEPTION");
                        console.dir(exception);
                    }
                );
            }

            onAssetsChange(assets) {

                // Remove existing items
                this.shadowRoot.host.querySelectorAll("or-asset-list-item").forEach((item) => {
                    this.shadowRoot.host.removeChild(item);
                });

                // Get the slotted template
                let assetTemplate = this.$.slot.assignedNodes().find((e) => {
                    return e instanceof HTMLTemplateElement;
                });

                if (!assetTemplate) {
                    console.warn("Missing <template> child element, rendering nothing on: " + this.tagName);
                    return;
                }

                // For each asset, create a new item element and append the template, then append to host element
                for (let asset of assets) {
                    let item = document.createElement("or-asset-list-item");
                    item.asset = asset;
                    item.appendChild(assetTemplate)
                    this.shadowRoot.host.appendChild(item);
                }
            }
        }

        registerOpenRemoteElement(OpenRemoteAssetList, OpenRemoteAssetList.is, "AssetList");
    </script>

</dom-module>